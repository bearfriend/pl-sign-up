<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../pl-input-decorator/pl-input-decorator.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-checkbox/paper-checkbox.html">
<link rel="import" href="../paper-shadow/paper-shadow.html">
<link rel="import" href="../paper-toast/paper-toast.html">
<link rel="import" href="../core-style/core-style.html">
<link rel="import" href="../core-ajax/core-ajax.html">
<link rel="import" href="../core-a11y-keys/core-a11y-keys.html">
<link rel="import" href="../core-overlay/core-overlay.html" />

<!--
Element providing solution to no problem in particular.

##### Example

    <pl-sign-up></pl-sign-up>

@element pl-sign-up
@blurb Element providing solution to no problem in particular.
@status alpha
@homepage http://polymerlabs.github.io/pl-sign-up
-->
<polymer-element name="pl-sign-up" layout horizontal reverse wrap around-justified attributes="marketing" on-input="{{ change }}" on-decorator-invalid="{{ decoratorInvalid }}">

  <template>

    <link rel="stylesheet" href="pl-sign-up.css" />

	<core-ajax id="ajax"
			   method="POST"
			   url="{{ userCreateUrl }}"
			   params="{{ params }}"
			   handleAs="json"
			   on-core-error="{{ signUpFailure }}"
			   on-core-response="{{ signUpSuccess }}"
			   withCredentials></core-ajax>
	
	<core-style ref="signInForm"></core-style>
	<core-card class="sso-card" id="core-card" vertical layout flex self-start>
	  <paper-shadow z="2"></paper-shadow>
	  <h1 id="heading">Create Account</h1>
	  <pl-input-decorator autofocus required="We'd like to know you on a first-name basis." label="First Name">
		<input id="first-name-input" value="{{ params.firstName }}" />
	  </pl-input-decorator>
	  <pl-input-decorator required="What did you say your last name was again?" label="Last Name">
		<input id="last-name-input" value="{{ params.lastName }}" />
	  </pl-input-decorator>
	  <pl-input-decorator required="An email address is required to sign up" error="Whoa buddy, this doesn't look like an email address." label="Email">
		<input id="email-input" type="email" value="{{ params.email }}" />
	  </pl-input-decorator>
	  <pl-input-decorator required="A password is required to sign up" error="Your password must be at least 8 characters long" label="Password" type="password">
		<input id="passw-input" type="password" value="{{ params.password }}" pattern=".{8,}" />
	  </pl-input-decorator>
	  <span layout horizontal class="form-row">
		<paper-checkbox class="form-row" label="" required id="agree-checkbox" on-core-change="{{ agreeChanged }}" start required></paper-checkbox>
		<div>I am 13 years of age or older and accept the <paper-button class="link" on-tap="{{ showTerms }}">Service Agreement</paper-button> and <paper-button class="link" on-tap="{{ showPolicy }}">Privacy Policy</paper-button>.</div>
	  </span>
	  <paper-button id="sign-up-button" class="form-row" on-click="{{ signUp }}" onfocus="console.log('focus');">Sign Up</paper-button>
	  <core-a11y-keys target="{{ $['sign-up-button'] }}" keys="enter space" on-keys-pressed="{{ signUp }}"></core-a11y-keys>
	  <a href="/#sign-in" class="small-text link form-row" center-text>I already have an account. <strong>Sign In</strong></a>
	</core-card>
	
	<template bind if="{{ marketing }}">
	  <ul class="marketing" center-text flex self-start>
		<li id="vp1">
		  <h1 class="marketing-heading" style="font-size: 1.1em">Your modern digital reader -<br />organized &amp; easy to find.</h1>
		  <p class="marketing-text">Make-up course work as you go,<br />in the style that you want.</p>
		</li>
		<li id="vp2">
		  <h1 class="marketing-heading" style="font-size: 1.1em">Your notes, your way -<br />intuitive &amp; interactive.</h1>
		  <p class="marketing-text">Quickly access your work<br />with an organization that <br />makes sense to you.</p>
		</li>
		<li id="vp3">
		  <h1 class="marketing-heading" style="font-size: 1.1em">Your go-to study spot -<br />ready when you are.</h1>
		  <p class="marketing-text">All your documents<br /> and coursework together.</p>
		</li>
	  </ul>

	</template>

	<core-overlay class="pl-signup-overlay" id="terms-overlay" backdrop layered closeattribute="close">
	  <paper-button class="link" close>Close</paper-button>
	  Terms of Service
	</core-overlay>

	<core-overlay class="pl-account-overlay" id="policy-overlay" backdrop layered closeattribute="close">
	  <paper-button class="link" close>Close</paper-button>
	  Privacy Policy
	</core-overlay>

	<core-overlay class="pl-account-overlay" id="success-overlay" backdrop layered closeattribute="close">
	  <paper-button class="link" close>Close</paper-button>
	  <div class="content"></div>
	</core-overlay>

	<paper-toast id="toast"></paper-toast>
	
	
	
  </template>

  <script>

    Polymer({
	  
	  /**
       * The `marketing` attribute determines whether or not to show marketing material as part of your `<pl-sign-up>`
       *
       * @attribute marketing
       * @type boolean
       * @default false
       */
	  marketing: false,

      /**
       * The `author` attribute sets an initial author
       *
       * @attribute author
       * @type string
       * @default 'Daniel Gleckler'
       */
      author: 'Daniel Gleckler',

      ready: function() {
        // Ready is a lifecycle callback.
        // You can do setup work in here.
        // More info: http://www.polymer-project.org/docs/polymer/polymer.html#lifecyclemethods


		this.params = {
		  firstName: '',
		  lastName: '',
		  email: '',
		  password: '',
		  agree: false,
		  token: 'a'
		}
      },

	  change: function() {
		
		if (this.shadowRoot.querySelectorAll('pl-input-decorator.invalid').length || !this.$['agree-checkbox'].checked) {
		  this.valid = false;
		}
		else {
		  this.valid = true;
		}
		
	  },

	  validate: function() {
		this.shadowRoot.querySelectorAll('pl-input-decorator').array()
					   .forEach(
						 function(input) {
						   input.validation = true;
						   input.startValidation();
						 });

		if (!this.$['agree-checkbox'].checked) {
		  this.$['agree-checkbox'].classList.add('invalid');
		}
		
		this.change();
		
	  },
	  
	  signUp: function() {
		
		this.validate();

		var that = this;
		
		// get in line - validation is event-based
		setTimeout(function() {

		  that.change();
		  
		  if (that.valid) {
			that.$.ajax.go();
		  }
		},0);
		
		
	  },

	  valid: false,
	  
	  userCreateUrl: 'http://54.84.119.67:1337/api/users/register', // this should be retrieved (http://54.84.119.67:1337/api/discovery/users/create/links/api), not hard-coded
	  
	  signUpSuccess: function(response) {
		this.$['success-overlay'].querySelector('.content').innerText = response.message || 'Success! Check your email for a confirmation link';
		this.$['success-overlay'].open();
	  },

	  signUpFailure: function(response) {
		this.$.toast.text = response.message || 'Whoops, looks like we\'re having trouble creating your account. Try again in a few minutes.'; // TODO: align this with actual server response message
		//this.$.toast.open();
		this.$.toast.opened = true;
	  },

	  // TODO: create a pl-checkbox with this functionality
	  agreeChanged: function(e,detal,el) {
		if (el.checked || !el.hasAttribute('required')) {
		  el.classList.remove('invalid');
		}
		
		this.change();
	  },

	  decoratorInvalid: function(e,detail,el) {
		console.log(detail.error);
	  },

	  showTerms: function() {
		this.$['terms-overlay'].open();
	  },

	  showPolicy: function() {
		this.$['policy-overlay'].open();
	  }
						 

    });

  </script>

</polymer-element>
